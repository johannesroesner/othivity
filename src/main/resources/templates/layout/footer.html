<div th:fragment="footer">
    <footer class="footer sm:footer-horizontal bg-base-200 shadow-2xl p-10">
        </footer>

    <script th:if="${currentUsername != null}" th:inline="javascript">
        const publicVapidKey = /*[[${vapidPublicKey}]]*/ null;

        // CSRF Token aus dem Head auslesen
        const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function sendSubscriptionToServer(subscription) {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            const response = await fetch('/api/push/subscribe', {
                method: 'POST',
                body: JSON.stringify(subscription),
                headers: headers
            });

            if (response.ok) {
                console.log("Subscription erfolgreich an Server gesendet.");
            } else {
                console.error("Fehler beim Senden der Subscription: ", response.status);
            }
        }

        async function initPushNotifications() {
            if (!publicVapidKey) return;

            if ('serviceWorker' in navigator) {
                try {
                    const register = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    await navigator.serviceWorker.ready;

                    let subscription = await register.pushManager.getSubscription();

                    if (!subscription) {
                        subscription = await register.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                        });
                    }

                    if (subscription) {
                        await sendSubscriptionToServer(subscription);
                    }

                } catch (error) {
                    console.error("Fehler bei Push Notifications:", error);
                }
            }
        }

        initPushNotifications();
    </script>
</div>