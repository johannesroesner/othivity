<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:data-theme="${currentThemeName}">
<head th:insert="~{layout/head :: head(#{explorer.pageTitle})}"></head>
<body class="flex flex-col min-h-screen">
<nav th:insert="~{layout/nav :: nav(activeTab='explorer')}"></nav>

<style>
    @keyframes flyInRight {
        from {
            opacity: 0;
            transform: translateX(50px) rotateY(-10deg);
        }
        to {
            opacity: 1;
            transform: translateX(0) rotateY(0);
        }
    }

    .animate-fly-in {
        animation: flyInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }
</style>

<div class="container mx-auto px-6 py-8 grow relative overflow-hidden">
<div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold" th:text="#{explorer.title}"></h1>
    </div>

    <div class="relative">
        <div class="flex flex-wrap justify-center gap-10 py-10">
            <div th:replace="~{fragments/card-stack :: cardStack(#{explorer.bestmix}, ${bestMixCards}, 'bestmix-card')}"></div>
            <div th:replace="~{fragments/card-stack :: cardStack(#{explorer.soonest}, ${soonestCards}, 'soonest-card')}"></div>
            <div th:replace="~{fragments/card-stack :: cardStack(#{explorer.closest}, ${closestCards}, 'closest-card')}"></div>
        </div>

        <div class="flex justify-center -mt-4 mb-8 relative z-20">
            <button onclick="rotateCards()" 
                    class="btn btn-primary shadow-2xl rounded-full">
                <span class="font-bold" th:text="#{explorer.rotateButton}"></span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>
    </div>

    <div class="mt-8">
        <div class="mb-2">
            <div role="tablist" class="tabs tabs-border flex space-x-2">
                <a role="tab" class="tab tab-active" id="bestMixTab" th:text="#{explorer.bestmix}"></a>
                <a role="tab" class="tab" id="soonestTab" th:text="#{explorer.soonest}"></a>
                <a role="tab" class="tab" id="closestTab" th:text="#{explorer.closest}"></a>
            </div>
        </div>

        <div id="bestMixTable" th:insert="~{fragments/activity-table :: activityTable(
             title=#{explorer.bestmix}, 
             activities=${bestMixActivities},
             pageParam='bestMixPage',
             activeTab=${activeTab},
             size=${size},
             sortBy=${sortBy},
             direction=${direction},
             tag=${tag},
             search=${search},
             allTags=${allTags},
             baseUrl='/explorer',
             hideSort=true)}"></div>

        <div id="soonestTable" class="hidden" th:insert="~{fragments/activity-table :: activityTable(
             title=#{explorer.soonest}, 
             activities=${soonestActivities},
             pageParam='soonestPage',
             activeTab=${activeTab},
             size=${size},
             sortBy=${sortBy},
             direction=${direction},
             tag=${tag},
             search=${search},
             allTags=${allTags},
             baseUrl='/explorer',
             hideSort=true)}"></div>

        <div id="closestTable" class="hidden" th:insert="~{fragments/activity-table :: activityTable(
             title=#{explorer.closest}, 
             activities=${closestActivities},
             pageParam='closestPage',
             activeTab=${activeTab},
             size=${size},
             sortBy=${sortBy},
             direction=${direction},
             tag=${tag},
             search=${search},
             allTags=${allTags},
             baseUrl='/explorer',
             hideSort=true)}"></div>
    </div>

</div>
<footer th:insert="~{layout/footer :: footer}"></footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    const soonestTab = document.getElementById("soonestTab");
    const closestTab = document.getElementById("closestTab");
    const bestMixTab = document.getElementById("bestMixTab");
    
    const soonestTable = document.getElementById("soonestTable");
    const closestTable = document.getElementById("closestTable");
    const bestMixTable = document.getElementById("bestMixTable");

    const activeTabParam = /*[[${activeTab}]]*/ 'bestMix';

    function showBestMix() { setActiveTab(bestMixTab, bestMixTable); }
    function showSoonest() { setActiveTab(soonestTab, soonestTable); }
    function showClosest() { setActiveTab(closestTab, closestTable); }

    soonestTab.onclick = showSoonest;
    closestTab.onclick = showClosest;
    bestMixTab.onclick = showBestMix;

    function setActiveTab(tab, table) {
        soonestTab.classList.remove("tab-active");
        closestTab.classList.remove("tab-active");
        bestMixTab.classList.remove("tab-active");
        
        soonestTable.classList.add("hidden");
        closestTable.classList.add("hidden");
        bestMixTable.classList.add("hidden");
        
        tab.classList.add("tab-active");
        table.classList.remove("hidden");
    }
    
    if (activeTabParam === 'soonest') showSoonest();
    else if (activeTabParam === 'closest') showClosest();
    else showBestMix();

    let currentIndex = 0;
    function rotateCards() {
        currentIndex++;
        updateColumn('bestmix-card', currentIndex);
        setTimeout(() => updateColumn('soonest-card', currentIndex), 200);
        setTimeout(() => updateColumn('closest-card', currentIndex), 400);
    }

    function updateColumn(className, index) {
        // Hier greift das JS nun auf die korrekten Klassennamen zu
        const cards = document.getElementsByClassName(className);
        if (cards.length === 0) return;
        
        for (let card of cards) {
            card.classList.add('hidden');
            card.classList.remove('animate-fly-in');
        }
        
        const targetIndex = index % cards.length;
        const targetCard = cards[targetIndex];
        
        targetCard.classList.remove('hidden');
        
        // Trigger reflow to restart animation
        void targetCard.offsetWidth;
        
        targetCard.classList.add('animate-fly-in');
    }

    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const hasLat = urlParams.has('lat');
        const hasLon = urlParams.has('lon');

        if (!hasLat || !hasLon) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('lat', lat);
                    newUrl.searchParams.set('lon', lon);
                    window.location.href = newUrl.toString();
                }, function(error) {
                    console.warn("Geolocation not available.");
                });
            }
        }
    });
    /*]]>*/
</script>
</body>
</html>